---
title: "**Visualising population mobility using Google, Apple, and Facebook data**"
params:
    google_path: ""
    apple_path: ""
    facebook_path: ""
    save_plots_to_jpg: FALSE
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.width = 10, fig.height = 8)

google_path <- params$google_path
apple_path <- params$apple_path
facebook_path <- params$facebook_path

save_plots_to_jpg <- params$save_plots_to_jpg

source("prepare_data_national.r")
```
<br>

## **Introduction**
These charts show how mobility has changed in Wales during the covid-19 pandemic using data that has been made available from [Apple](https://covid19.apple.com/mobility), [Facebook](https://data.humdata.org/dataset/movement-range-maps) and [Google](https://www.google.com/covid19/mobility/). A 7 day average has been used throughout. 

<br>


### **Google mobility data**
<br>
These charts show changes in mobility for those using Google maps. The information is created with aggregated, anonymized sets of data from users who have turned on the Location History setting. The baseline is the median value, for the corresponding day of the week, during the 5-week period Jan 3–Feb 6, 2020. The data shows changes broken down by six areas: retail & recreation, parks, supermarkets & pharmacy, workplaces, residential and public transport. Data are available for the local authority areas in Wales. An average of those is used to derive a Wales figure. No weighting is applied to account for the different sizes of each local authority – that is because that information is not available from Google, only relative change.
<br>

```{r}
google_plot_wales <- google_wales_rolling_avg %>%
    ggplot(aes(x = date, y = rolling_avg, color = variable)) +
    geom_line(size = 1) +
    labs(
        x = "Date",
        y = "% change from baseline",
        title = "Change in mobility from baseline - Average of Welsh local authorities
                (7 day rolling average)",
        color = "Measure\n",
        caption = 'Source: Google LLC "Google COVID-19 Community Mobility Reports."',
        color = ""
    ) +
    theme_minimal() +
    theme(
       legend.position = "bottom",
       plot.title = element_text(hjust = 0.5),
       panel.grid.major.x = element_blank(),
       panel.grid.minor.x = element_blank(),
       panel.grid.minor.y = element_blank()
    ) +
    scale_x_date(date_breaks = "1 month", date_labels = "%B") +
    scale_y_continuous(breaks = seq(-100, 100, by = 25)) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "grey", size = 1) +
    guides(color = guide_legend(override.aes = list(size = 2)))

google_plot_wales
```

<br>

```{r}
google_plot_nation <- google_nation_rolling_average %>%
    ggplot(aes(x = date, y = rolling_avg, color = REGION_NM)) +
    geom_line(size = 1) +
    labs(
        x = "Date",
        y = "% change from baseline",
        title = "Change in mobility from baseline - average of areas in each nation
                    (7 day rolling average)",
        color = "",
        caption = c('Source: Google LLC "Google COVID-19 Community Mobility Reports."',
                    'Based on the average of all measures')
    ) +
    theme_minimal() +
    theme(
        legend.position = "bottom",
        plot.title = element_text(hjust = 0.5),
        plot.caption = element_text(hjust=c(1, 0)),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank()
    ) +
    scale_x_date(date_breaks = "1 month", date_labels = "%B") +
    scale_y_continuous(breaks = seq(-100, 20, by = 10)) +
    scale_color_manual(
        breaks = c("England", "Wales", "Scotland", "Northern Ireland"),
        values = c("#F8766D", "#C77CFF", "#00BF7D", "#00B0F6")
    ) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "grey", size = 1) +
    guides(color = guide_legend(override.aes = list(size = 2)))

google_plot_nation

```

<br>
<br>
<br>

### **Apple mobility data**
<br>
These charts show routing requests for different modes of transport for those who use Apple maps. It covers walking, driving and public transport (transit). The baseline is the 13th January. The data is generated by counting the number of requests made to Apple Maps for directions in select countries/regions, sub-regions and cities. It is available for each of the four nations and some cities in the UK, including Cardiff.
<br>

```{r}
apple_plot_nations <- apple_nations_rolling_average %>%
    ggplot(aes(x = date, y = rolling_avg, color = region)) +
    geom_line(size = 1) +
    labs(
        x = "Date",
        y = "Index of requests made\n (January 13th = 100)",
        title = "Apple mobility data for the UK\n (7 day rolling average)",
        color = "",
        caption = c(
            "Source: Apple",
            "Baseline is January 13th (change is relative to requests that day)"
        )
    ) +
    scale_x_date(date_labels = "%B") +
    scale_color_manual(
        breaks = c("England", "Wales", "Scotland", "Northern Ireland", "United Kingdom"),
        values = c("#F8766D", "#C77CFF", "#00BF7D", "#00B0F6", "#B79F00")
    ) +
    theme_bw() +
    theme(
        legend.position = "bottom",
        plot.title = element_text(hjust = 0.5),
        plot.caption = element_text(hjust=c(1, 0)),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank()
    ) +
    geom_hline(yintercept = 100, linetype = "dashed", color = "grey", size = 1) +
    guides(color = guide_legend(override.aes = list(size = 2))) +
    facet_wrap(~transportation_type)

apple_plot_nations
```
<br>

```{r}
apple_plot_cities <- apple_cities_rolling_average %>%
    ggplot(aes(x = date, y = rolling_avg, color = region)) +
    geom_line(size = 1) +
    labs(
        x = "Date",
        y = "Index of requests made\n (January 13th = 100)",
        color = "",
        title = "Apple mobility data for Cardiff and Bristol\n (7 Day rolling Average)",
        caption = c(
            "Source: Apple",
            "Baseline is January 13th (change is relative to requests that day)"
        )
    ) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    theme_bw() + 
    theme(
        legend.position = "bottom",
        plot.title = element_text(hjust = 0.5),
        plot.caption = element_text(hjust=c(1, 0)),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank()
    ) +
    scale_x_date(date_breaks = "3 months", date_labels = "%B") +
    geom_hline(yintercept = 100, linetype = "dashed", color = "grey", size = 1) +
    guides(color = guide_legend(override.aes = list(size = 2))) +
    facet_wrap(~transportation_type)

apple_plot_cities
```
<br>
<br>
<br>

### **Facebook mobility data**
<br>
These charts show changes in mobility of Facebook users. Only people who opt in to Location History and background location collection are included. The baseline is period 2-29 February and changes are relative to the same day of the week in that baseline period. There are two metrics, Change in Movement and Stay Put, that provide a slightly different perspective on movement trends. Change in Movement looks at how much people are moving around and compares it with a baseline period that predates most social distancing measures, while Stay Put looks at the fraction of the population that appear to stay within a small area during an entire day. Data are available for each of the four nations.
<br>
```{r}
facebook_plot_stay_put <- facebook_rolling_average %>%
    filter(variable == "all_day_ratio_single_tile_users") %>%
    ggplot(aes(x = ds, y = rolling_avg, color = polygon_name)) +
    geom_line(size = 1) +
    labs(
        x = "Date",
        y = "",
        color = "",
        title = "Percentage of Facebook users 'staying put' (7 day rolling average)",
        caption = c(
            "Source: Facebook",
            "This is based on the % of people who remained\n in one location (approx. 600m2) for 24 hours"
        )
    ) +
    theme_minimal() + 
    theme(
        legend.position = "bottom",
        plot.title = element_text(hjust = 0.5),
        plot.caption = element_text(hjust=c(1, 0)),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank()
    ) +
    scale_x_date(date_breaks = "1 month", date_labels = "%B") +
    scale_y_continuous(limits = c(0, 0.5), labels = scales::percent_format(accuracy = 1)) +
    scale_color_manual(
        breaks = c("England", "Wales", "Scotland", "Northern Ireland"),
        values = c("#F8766D", "#C77CFF", "#00BF7D", "#00B0F6")
    ) +
    guides(color = guide_legend(override.aes = list(size = 2)))

facebook_plot_stay_put

```
<br>

```{r}
facebook_plot_move <- facebook_rolling_average %>%
    filter(variable == "all_day_bing_tiles_visited_relative_change") %>%
    ggplot(aes(x = ds, y = rolling_avg, color = polygon_name)) +
    geom_line(size = 1) +
    labs(
        x = "Date",
        y = "",
        color = "",
        title = "Change in Facebook users movement relative to baseline\n (7 day rolling average)",
        caption = c(
            "Source: Facebook",
            "Baseline is change relative to same day in February and\n looks at mobility (number of bing tiles user appears in)"
        )
    ) +
    scale_x_date(date_breaks = "1 month", date_labels = "%B") +
    scale_y_continuous(limits = c(-0.6, 0.1), labels = scales::percent_format(accuracy = 1)) +
    scale_color_manual(
        breaks = c("England", "Wales", "Scotland", "Northern Ireland"),
        values = c("#F8766D", "#C77CFF", "#00BF7D", "#00B0F6")
    ) +
    theme_minimal() + 
    theme(
        legend.position = "bottom",
        plot.title = element_text(hjust = 0.5),
        plot.caption = element_text(hjust=c(1, 0)),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank()
    ) +
    geom_hline(yintercept = 0, linetype = 'dashed', color = 'grey') +
    guides(color = guide_legend(override.aes = list(size = 2)))

facebook_plot_move
```

```{r}
# Save images files
save_mobility_plot <- function(plot) {
     
    name <- paste0("images/", deparse(substitute(plot)), "_", Sys.Date(), ".jpg")
    ggsave(name, plot = plot)
}

if (save_plots_to_jpg == TRUE) {
    save_mobility_plot(google_plot_wales)
    save_mobility_plot(google_plot_nation)
    save_mobility_plot(apple_plot_cities)
    save_mobility_plot(apple_plot_driving)
    save_mobility_plot(facebook_plot_move)
    save_mobility_plot(facebook_plot_stay_put)
}

```

